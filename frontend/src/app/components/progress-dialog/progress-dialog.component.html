<div class="modern-dialog-container">
  <div class="dialog-header">
    <h2>處理進度追蹤</h2>
    <div class="header-decoration"></div>
  </div>

  <div class="dialog-content">
    <!-- 總體進度卡片 -->
    <div class="progress-card">
      <div class="card-section">
        <div class="progress-title">
          <span>總體處理進度</span>
          <div class="progress-percentage-container">
            <span class="progress-percentage"
              >{{ getProgressPercentage() }}%</span
            >
          </div>
        </div>

        <!-- 客製化總進度條，改良版，使用動畫效果 -->
        <div class="progress-bar-container">
          <div
            class="progress-fill"
            [style.width.%]="getProgressPercentage()"
            [class.high]="getProgressPercentage() >= 70"
            [class.medium]="
              getProgressPercentage() >= 40 && getProgressPercentage() < 70
            "
            [class.low]="
              getProgressPercentage() < 40 && getProgressPercentage() > 0
            "
          >
            <span
              class="progress-animation-dot"
              *ngIf="
                getProgressPercentage() > 0 && getProgressPercentage() < 100
              "
            ></span>
          </div>
        </div>
      </div>

      <div class="stat-cards">
        <div class="stat-card">
          <div class="stat-icon total-icon">
            <mat-icon>list_alt</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ totalItems }}</div>
            <div class="stat-label">總計項目</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon success-icon">
            <mat-icon>check_circle</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ completedItems }}</div>
            <div class="stat-label">已完成</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon danger-icon">
            <mat-icon>error</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ failedItems }}</div>
            <div class="stat-label">失敗項目</div>
          </div>
        </div>
      </div>
    </div>

    <!-- 項目進度表格 -->
    <div class="items-table-container">
      <div class="table-header">
        <h3>項目詳細進度</h3>
      </div>

      <div class="table-wrapper">
        <table mat-table [dataSource]="itemStatuses" class="modern-table">
          <!-- 名稱列 -->
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef>產品名稱</th>
            <td mat-cell *matCellDef="let item">
              <div class="item-name">{{ item.name }}</div>
            </td>
          </ng-container>

          <!-- 類型列 -->
          <ng-container matColumnDef="type">
            <th mat-header-cell *matHeaderCellDef>類型</th>
            <td mat-cell *matCellDef="let item">
              <div class="type-badge" [ngClass]="item.type">
                {{ item.type === "fund" ? "基金" : "債券" }}
              </div>
            </td>
          </ng-container>

          <!-- 代碼列 -->
          <ng-container matColumnDef="code">
            <th mat-header-cell *matHeaderCellDef>產品代碼</th>
            <td mat-cell *matCellDef="let item">
              <div class="code-chip">{{ item.code }}</div>
            </td>
          </ng-container>

          <!-- 詳細狀態列 -->
          <ng-container matColumnDef="detailedStatus">
            <th mat-header-cell *matHeaderCellDef>處理狀態</th>
            <td mat-cell *matCellDef="let item">
              <div class="status-wrapper" [ngClass]="'status-' + item.status">
                <div class="status-indicator">
                  <mat-icon *ngIf="item.status === 'completed'"
                    >check_circle</mat-icon
                  >
                  <mat-icon *ngIf="item.status === 'failed'">cancel</mat-icon>
                  <mat-icon *ngIf="item.status === 'pending'"
                    >schedule</mat-icon
                  >
                  <div
                    *ngIf="item.status === 'processing'"
                    class="processing-spinner"
                  >
                    <mat-progress-spinner
                      diameter="24"
                      mode="indeterminate"
                    ></mat-progress-spinner>
                  </div>
                </div>
                <span class="status-text">{{ item.detailedStatus }}</span>
              </div>
            </td>
          </ng-container>

          <!-- 進度條列 -->
          <ng-container matColumnDef="progress">
            <th mat-header-cell *matHeaderCellDef>進度</th>
            <td mat-cell *matCellDef="let item">
              <div class="progress-cell">
                <div class="progress-bar-container">
                  <div
                    class="progress-fill"
                    [class.high]="item.progress >= 70"
                    [class.medium]="item.progress >= 40 && item.progress < 70"
                    [class.low]="item.progress < 40 && item.progress > 0"
                    [style.width.%]="item.progress"
                    [style.transition]="'width 0.3s ease-out'"
                  >
                    <span
                      class="progress-animation-dot"
                      *ngIf="item.status === 'processing'"
                    ></span>
                  </div>
                </div>
                <div
                  class="progress-badge"
                  [ngClass]="{
                    completed: item.status === 'completed',
                    failed: item.status === 'failed',
                    processing: item.status === 'processing',
                    pending: item.status === 'pending'
                  }"
                >
                  {{ item.progress }}%
                </div>
              </div>
            </td>
          </ng-container>

          <tr
            mat-header-row
            *matHeaderRowDef="displayedColumns; sticky: true"
          ></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: displayedColumns"
            [ngClass]="'status-row-' + row.status"
            class="table-row-animate"
          ></tr>
        </table>
      </div>
    </div>
  </div>

  <div class="dialog-actions">
    <button
      mat-flat-button
      [disabled]="!allTasksCompleted()"
      (click)="closeDialog()"
      class="close-button"
      [ngClass]="{ enabled: allTasksCompleted() }"
    >
      <mat-icon>check</mat-icon>
      完成
    </button>
  </div>
</div>
