<h2 mat-dialog-title class="dialog-header">處理進度</h2>

<div mat-dialog-content>
  <div class="progress-summary">
    <div class="progress-title">
      <span>總體進度</span>
      <span class="progress-percentage">{{ getProgressPercentage() }}%</span>
    </div>
    <mat-progress-bar
      class="custom-progress-bar"
      mode="determinate"
      [value]="getProgressPercentage()"
    ></mat-progress-bar>
    <div class="progress-stats">
      <div class="stat-item">
        <div class="stat-value">{{ totalItems }}</div>
        <div class="stat-label">總計項目</div>
      </div>
      <div class="stat-item success">
        <div class="stat-value">{{ completedItems }}</div>
        <div class="stat-label">已完成</div>
      </div>
      <div class="stat-item danger">
        <div class="stat-value">{{ failedItems }}</div>
        <div class="stat-label">失敗項目</div>
      </div>
    </div>
  </div>

  <div class="status-table-container">
    <table
      mat-table
      [dataSource]="itemStatuses"
      class="custom-table mat-elevation-z2"
    >
      <!-- 名稱列 -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>產品名稱</th>
        <td mat-cell *matCellDef="let item">{{ item.name }}</td>
      </ng-container>

      <!-- 類型列 -->
      <ng-container matColumnDef="type">
        <th mat-header-cell *matHeaderCellDef>類型</th>
        <td mat-cell *matCellDef="let item">
          <span
            class="type-badge"
            [ngClass]="{
              fund: item.type === 'fund',
              bond: item.type === 'bond'
            }"
          >
            {{ item.type === "fund" ? "基金" : "債券" }}
          </span>
        </td>
      </ng-container>

      <!-- 代碼列 -->
      <ng-container matColumnDef="code">
        <th mat-header-cell *matHeaderCellDef>產品代碼</th>
        <td mat-cell *matCellDef="let item">
          <span class="code-value">{{ item.code }}</span>
        </td>
      </ng-container>

      <!-- 狀態列 -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>處理狀態</th>
        <td mat-cell *matCellDef="let item">
          <div class="status-indicator">
            <!-- 已完成 -->
            <div
              *ngIf="item.status === 'completed'"
              class="status-box completed"
            >
              <mat-icon class="status-icon">check_circle</mat-icon>
              <span>處理完成</span>
            </div>

            <!-- 失敗 -->
            <div *ngIf="item.status === 'failed'" class="status-box failed">
              <mat-icon class="status-icon">cancel</mat-icon>
              <span>{{ item.message }}</span>
            </div>

            <!-- 處理中動畫 -->
            <div
              *ngIf="item.status === 'processing'"
              class="status-box processing"
            >
              <div class="pulse-container">
                <div class="pulse-dot"></div>
              </div>
              <span>處理中</span>
              <span class="dots">
                <span class="dot">.</span>
                <span class="dot">.</span>
                <span class="dot">.</span>
              </span>
            </div>

            <!-- 等待處理 -->
            <div *ngIf="item.status === 'pending'" class="status-box pending">
              <mat-icon class="status-icon">hourglass_empty</mat-icon>
              <span>等待處理</span>
            </div>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>
  </div>
</div>

<div mat-dialog-actions class="action-buttons">
  <button
    mat-raised-button
    color="primary"
    class="close-button"
    [disabled]="!allTasksCompleted()"
    (click)="closeDialog()"
  >
    關閉
  </button>
</div>
